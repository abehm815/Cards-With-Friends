<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GofishActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debug</a> &gt; <a href="index.source.html" class="el_package">com.example.androidexample</a> &gt; <span class="el_source">GofishActivity.java</span></div><h1>GofishActivity.java</h1><pre class="source lang-java linenums">package com.example.androidexample;

import android.app.AlertDialog;
import android.content.Intent;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.LinearLayout;
import android.widget.TextView;
import android.widget.Toast;
import androidx.appcompat.app.AppCompatActivity;
import androidx.constraintlayout.widget.ConstraintLayout;
import androidx.constraintlayout.widget.ConstraintSet;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.util.ArrayList;
import java.util.List;

import com.example.androidexample.services.CardView;
import com.example.androidexample.services.WebSocketListener;
import com.example.androidexample.services.WebSocketManager;

import org.java_websocket.handshake.ServerHandshake;

<span class="fc" id="L29">public class GofishActivity extends AppCompatActivity implements WebSocketListener {</span>

    private static final String TAG = &quot;GofishActivity&quot;;

    private static final float CENTER_X_BIAS = 0.5f;
    private static final float CENTER_Y_BIAS = 0.75f;
    private static final float RADIUS_BIAS = 1.4f;
    private static final float TOTAL_SPREAD = 30f;

    private static final int CARD_WIDTH = 150;
    private static final int CARD_HEIGHT = 200;

    private String joinCode;
    private String username;
    private boolean isHost;
    private String gameType;
    private ArrayList&lt;String&gt; playerList;

<span class="fc" id="L47">    private CardView selectedCard = null;</span>
    private ConstraintLayout rootLayout;
    private List&lt;CardView&gt; cards;
<span class="fc" id="L50">    private GameState gameState = new GameState();</span>
<span class="fc" id="L51">    private boolean gameStarted = false;</span>

    // UI Elements
    private LinearLayout playerListLayout;
    private Button askButton;
    private Button startGameButton;
    private TextView gameStatusText;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
<span class="fc" id="L61">        super.onCreate(savedInstanceState);</span>
<span class="fc" id="L62">        setContentView(R.layout.activity_gofish);</span>

<span class="fc" id="L64">        Intent intent = getIntent();</span>
<span class="fc" id="L65">        gameType = intent.getStringExtra(&quot;GAMETYPE&quot;);</span>
<span class="fc" id="L66">        username = intent.getStringExtra(&quot;USERNAME&quot;);</span>
<span class="fc" id="L67">        joinCode = intent.getStringExtra(&quot;JOINCODE&quot;);</span>
<span class="fc" id="L68">        isHost = intent.getBooleanExtra(&quot;HOST&quot;, false);</span>
<span class="fc" id="L69">        playerList = intent.getStringArrayListExtra(&quot;PLAYERS&quot;);</span>

<span class="fc" id="L71">        initializeViews();</span>
<span class="fc" id="L72">        setupListeners();</span>
<span class="fc" id="L73">    }</span>

    private void initializeViews() {
<span class="fc" id="L76">        rootLayout = findViewById(R.id.rootLayout);</span>
<span class="fc" id="L77">        playerListLayout = findViewById(R.id.playerList);</span>
<span class="fc" id="L78">        askButton = findViewById(R.id.gofish_ask_button);</span>
<span class="fc" id="L79">        cards = new ArrayList&lt;&gt;();</span>

        // Create start game button dynamically
<span class="fc" id="L82">        startGameButton = new Button(this);</span>
<span class="fc" id="L83">        startGameButton.setId(View.generateViewId());</span>
<span class="fc" id="L84">        startGameButton.setText(&quot;Start Game&quot;);</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">        startGameButton.setVisibility(isHost ? View.VISIBLE : View.GONE);</span>

<span class="fc" id="L87">        ConstraintLayout.LayoutParams params = new ConstraintLayout.LayoutParams(</span>
                ConstraintLayout.LayoutParams.WRAP_CONTENT,
                ConstraintLayout.LayoutParams.WRAP_CONTENT
        );
<span class="fc" id="L91">        startGameButton.setLayoutParams(params);</span>
<span class="fc" id="L92">        rootLayout.addView(startGameButton);</span>

        // Position start button in center
<span class="fc" id="L95">        ConstraintSet set = new ConstraintSet();</span>
<span class="fc" id="L96">        set.clone(rootLayout);</span>
<span class="fc" id="L97">        set.connect(startGameButton.getId(), ConstraintSet.START, rootLayout.getId(), ConstraintSet.START, 0);</span>
<span class="fc" id="L98">        set.connect(startGameButton.getId(), ConstraintSet.END, rootLayout.getId(), ConstraintSet.END, 0);</span>
<span class="fc" id="L99">        set.connect(startGameButton.getId(), ConstraintSet.TOP, rootLayout.getId(), ConstraintSet.TOP, 0);</span>
<span class="fc" id="L100">        set.connect(startGameButton.getId(), ConstraintSet.BOTTOM, rootLayout.getId(), ConstraintSet.BOTTOM, 0);</span>
<span class="fc" id="L101">        set.applyTo(rootLayout);</span>

        // Create game status text
<span class="fc" id="L104">        gameStatusText = new TextView(this);</span>
<span class="fc" id="L105">        gameStatusText.setId(View.generateViewId());</span>
<span class="fc" id="L106">        gameStatusText.setTextSize(18);</span>
<span class="fc" id="L107">        gameStatusText.setTextColor(0xFFFFFFFF);</span>
<span class="fc" id="L108">        gameStatusText.setText(&quot;Waiting for host to start game...&quot;);</span>
<span class="fc" id="L109">        gameStatusText.setVisibility(View.VISIBLE);</span>

<span class="fc" id="L111">        ConstraintLayout.LayoutParams textParams = new ConstraintLayout.LayoutParams(</span>
                ConstraintLayout.LayoutParams.WRAP_CONTENT,
                ConstraintLayout.LayoutParams.WRAP_CONTENT
        );
<span class="fc" id="L115">        gameStatusText.setLayoutParams(textParams);</span>
<span class="fc" id="L116">        rootLayout.addView(gameStatusText);</span>

        // Position status text at top center
<span class="fc" id="L119">        set.clone(rootLayout);</span>
<span class="fc" id="L120">        set.connect(gameStatusText.getId(), ConstraintSet.START, rootLayout.getId(), ConstraintSet.START, 0);</span>
<span class="fc" id="L121">        set.connect(gameStatusText.getId(), ConstraintSet.END, rootLayout.getId(), ConstraintSet.END, 0);</span>
<span class="fc" id="L122">        set.connect(gameStatusText.getId(), ConstraintSet.TOP, rootLayout.getId(), ConstraintSet.TOP, 50);</span>
<span class="fc" id="L123">        set.applyTo(rootLayout);</span>

        // Hide ask button initially
<span class="fc" id="L126">        askButton.setVisibility(View.GONE);</span>
<span class="fc" id="L127">        askButton.setText(&quot;Ask&quot;);</span>
<span class="fc" id="L128">    }</span>

    private void setupListeners() {
<span class="pc" id="L131">        askButton.setOnClickListener(v -&gt; handleAskButtonClick());</span>
<span class="pc" id="L132">        startGameButton.setOnClickListener(v -&gt; startGame());</span>
<span class="fc" id="L133">    }</span>

    @Override
    protected void onStart() {
<span class="fc" id="L137">        super.onStart();</span>
<span class="fc" id="L138">        String wsUrl = &quot;ws://coms-3090-006.class.las.iastate.edu:8080/gofish/&quot; + joinCode;</span>
<span class="fc" id="L139">        Log.d(TAG, &quot;Connecting to WebSocket: &quot; + wsUrl);</span>
<span class="fc" id="L140">        WebSocketManager.getInstance().connectWebSocket(wsUrl);</span>
<span class="fc" id="L141">        WebSocketManager.getInstance().setWebSocketListener(this);</span>
<span class="fc" id="L142">    }</span>

    @Override
    protected void onStop() {
<span class="fc" id="L146">        super.onStop();</span>
<span class="fc" id="L147">        WebSocketManager.getInstance().disconnectWebSocket();</span>
<span class="fc" id="L148">    }</span>

    @Override
    public void onWebSocketOpen(ServerHandshake handshakedata) {
<span class="fc" id="L152">        runOnUiThread(() -&gt; {</span>
<span class="fc" id="L153">            Log.d(TAG, &quot;WebSocket connected&quot;);</span>
<span class="fc" id="L154">            Toast.makeText(this, &quot;Connected to game server&quot;, Toast.LENGTH_SHORT).show();</span>

            // Only request state if game hasn't started yet
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">            if (!gameStarted) {</span>
<span class="fc" id="L158">                requestGameState();</span>
            }
<span class="fc" id="L160">        });</span>
<span class="fc" id="L161">    }</span>

    @Override
    public void onWebSocketMessage(String message) {
<span class="fc" id="L165">        runOnUiThread(() -&gt; {</span>
<span class="fc" id="L166">            Log.d(TAG, &quot;Received message: &quot; + message);</span>

            // Check if it's a plain text message (not JSON)
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">            if (!message.trim().startsWith(&quot;{&quot;)) {</span>
<span class="fc" id="L170">                Log.d(TAG, &quot;Received plain text message: &quot; + message);</span>

                // Filter out messages that shouldn't be shown as toasts
<span class="fc" id="L173">                boolean shouldShowToast = true;</span>

                // Don't show &quot;no game running&quot; errors
<span class="fc bfc" id="L176" title="All 2 branches covered.">                if (message.toLowerCase().contains(&quot;no game running&quot;)) {</span>
<span class="fc" id="L177">                    shouldShowToast = false;</span>
                }

                // Don't show &quot;went fishing and drew&quot; messages (these reveal cards)
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">                if (message.contains(&quot;went fishing and drew&quot;)) {</span>
<span class="nc" id="L182">                    shouldShowToast = false;</span>
                }

                // Don't show &quot;received a&quot; messages to everyone (only log them)
<span class="pc bpc" id="L186" title="3 of 4 branches missed.">                if (message.contains(&quot;received a&quot;) &amp;&amp; message.contains(&quot; from &quot;)) {</span>
<span class="nc" id="L187">                    shouldShowToast = false;</span>
                }

<span class="fc bfc" id="L190" title="All 2 branches covered.">                if (shouldShowToast) {</span>
<span class="fc" id="L191">                    Toast.makeText(this, message, Toast.LENGTH_SHORT).show();</span>
                }

                // If we get a &quot;game started&quot; type message, request the state
<span class="pc bpc" id="L195" title="2 of 4 branches missed.">                if (message.toLowerCase().contains(&quot;started&quot;) || message.toLowerCase().contains(&quot;new game&quot;)) {</span>
<span class="nc" id="L196">                    Log.d(TAG, &quot;Game started confirmation received, requesting state...&quot;);</span>
<span class="nc" id="L197">                    requestGameState();</span>
                }
<span class="fc" id="L199">                return;</span>
            }

            try {
<span class="nc" id="L203">                JSONObject json = new JSONObject(message);</span>
<span class="nc" id="L204">                Log.d(TAG, &quot;Parsing JSON game state...&quot;);</span>
<span class="nc" id="L205">                gameState = parseGameState(json);</span>
<span class="nc" id="L206">                gameStarted = true;</span>

                // Hide start button once game starts
<span class="nc" id="L209">                startGameButton.setVisibility(View.GONE);</span>
<span class="nc" id="L210">                gameStatusText.setVisibility(View.GONE);</span>

<span class="nc" id="L212">                Log.d(TAG, &quot;Game state parsed successfully. Players: &quot; + gameState.players.size());</span>
<span class="nc" id="L213">                updateUIFromState();</span>

<span class="nc" id="L215">            } catch (JSONException e) {</span>
<span class="nc" id="L216">                Log.e(TAG, &quot;Error parsing message: &quot; + message, e);</span>
<span class="nc" id="L217">                e.printStackTrace();</span>
<span class="nc" id="L218">            }</span>
<span class="nc" id="L219">        });</span>
<span class="fc" id="L220">    }</span>

    @Override
    public void onWebSocketClose(int code, String reason, boolean remote) {
<span class="fc" id="L224">        Log.e(TAG, &quot;Closed → code=&quot; + code +</span>
<span class="pc bpc" id="L225" title="1 of 2 branches missed.">                &quot;, reason=&quot; + (reason == null ? &quot;null&quot; : reason) +</span>
                &quot;, remote=&quot; + remote);
<span class="fc" id="L227">    }</span>

    @Override
    public void onWebSocketError(Exception ex) {
<span class="nc" id="L231">        Log.e(TAG, &quot;Error → &quot; + ex.getMessage(), ex);</span>
<span class="nc" id="L232">    }</span>

    // -------------------------------------------------------------------
    // WebSocket Message Sending
    // -------------------------------------------------------------------

    private void startGame() {
<span class="nc" id="L239">        Log.d(TAG, &quot;Start button clicked!&quot;);</span>

        try {
<span class="nc" id="L242">            JSONObject message = new JSONObject();</span>
<span class="nc" id="L243">            message.put(&quot;type&quot;, &quot;start&quot;);</span>

            // Use the player list passed from LobbyViewActivity
<span class="nc" id="L246">            JSONArray playerArray = new JSONArray();</span>
<span class="nc bnc" id="L247" title="All 4 branches missed.">            if (playerList != null &amp;&amp; !playerList.isEmpty()) {</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">                for (String player : playerList) {</span>
<span class="nc" id="L249">                    playerArray.put(player);</span>
<span class="nc" id="L250">                }</span>
<span class="nc" id="L251">                Log.d(TAG, &quot;Player list size: &quot; + playerList.size());</span>
<span class="nc" id="L252">                Log.d(TAG, &quot;Players: &quot; + playerList.toString());</span>
            } else {
                // Fallback: just add current user
<span class="nc" id="L255">                playerArray.put(username);</span>
<span class="nc" id="L256">                Log.w(TAG, &quot;Player list was null/empty, using only current user&quot;);</span>
            }

<span class="nc" id="L259">            message.put(&quot;players&quot;, playerArray);</span>

<span class="nc" id="L261">            String msg = message.toString();</span>
<span class="nc" id="L262">            Log.d(TAG, &quot;Sending start message: &quot; + msg);</span>
<span class="nc" id="L263">            WebSocketManager.getInstance().sendMessage(msg);</span>

<span class="nc" id="L265">            Toast.makeText(this, &quot;Starting game...&quot;, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L266">        } catch (JSONException e) {</span>
<span class="nc" id="L267">            Log.e(TAG, &quot;Error creating start message&quot;, e);</span>
<span class="nc" id="L268">            Toast.makeText(this, &quot;Error starting game&quot;, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L269">        }</span>
<span class="nc" id="L270">    }</span>

    private void requestGameState() {
        try {
<span class="fc" id="L274">            JSONObject message = new JSONObject();</span>
<span class="fc" id="L275">            message.put(&quot;type&quot;, &quot;state&quot;);</span>

<span class="fc" id="L277">            String msg = message.toString();</span>
<span class="fc" id="L278">            Log.d(TAG, &quot;Requesting state: &quot; + msg);</span>
<span class="fc" id="L279">            WebSocketManager.getInstance().sendMessage(msg);</span>
<span class="nc" id="L280">        } catch (JSONException e) {</span>
<span class="nc" id="L281">            Log.e(TAG, &quot;Error creating state request&quot;, e);</span>
<span class="fc" id="L282">        }</span>
<span class="fc" id="L283">    }</span>

    private void handleAskButtonClick() {
        // First, show player selection dialog
<span class="nc" id="L287">        showPlayerSelectionDialog();</span>
<span class="nc" id="L288">    }</span>

    private void showPlayerSelectionDialog() {
        // Get list of other players (not current user)
<span class="nc" id="L292">        List&lt;String&gt; otherPlayers = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        for (PlayerState p : gameState.players) {</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">            if (!p.username.equals(username)) {</span>
<span class="nc" id="L295">                otherPlayers.add(p.username);</span>
            }
<span class="nc" id="L297">        }</span>

<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (otherPlayers.isEmpty()) {</span>
<span class="nc" id="L300">            Toast.makeText(this, &quot;No other players available&quot;, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L301">            return;</span>
        }

<span class="nc" id="L304">        String[] playerArray = otherPlayers.toArray(new String[0]);</span>

<span class="nc" id="L306">        AlertDialog.Builder builder = new AlertDialog.Builder(this);</span>
<span class="nc" id="L307">        builder.setTitle(&quot;Ask which player?&quot;);</span>
<span class="nc" id="L308">        builder.setItems(playerArray, (dialog, which) -&gt; {</span>
<span class="nc" id="L309">            String targetPlayer = playerArray[which];</span>
            // After selecting player, show rank selection
<span class="nc" id="L311">            showRankSelectionDialog(targetPlayer);</span>
<span class="nc" id="L312">        });</span>
<span class="nc" id="L313">        builder.setNegativeButton(&quot;Cancel&quot;, null);</span>
<span class="nc" id="L314">        builder.show();</span>
<span class="nc" id="L315">    }</span>

    private void showRankSelectionDialog(String targetPlayer) {
        // Get unique card values from current player's hand
<span class="nc" id="L319">        PlayerState currentPlayer = null;</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">        for (PlayerState p : gameState.players) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">            if (p.username.equals(username)) {</span>
<span class="nc" id="L322">                currentPlayer = p;</span>
<span class="nc" id="L323">                break;</span>
            }
<span class="nc" id="L325">        }</span>

<span class="nc bnc" id="L327" title="All 4 branches missed.">        if (currentPlayer == null || currentPlayer.hand.isEmpty()) {</span>
<span class="nc" id="L328">            Toast.makeText(this, &quot;You have no cards to ask for&quot;, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L329">            return;</span>
        }

        // Get unique values from hand
<span class="nc" id="L333">        List&lt;Integer&gt; uniqueValues = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L334">        List&lt;String&gt; displayNames = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L336" title="All 2 branches missed.">        for (CardState card : currentPlayer.hand) {</span>
<span class="nc" id="L337">            int value = convertStringToValue(card.value);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">            if (!uniqueValues.contains(value)) {</span>
<span class="nc" id="L339">                uniqueValues.add(value);</span>
<span class="nc" id="L340">                displayNames.add(card.value); // Use the display string (A, K, Q, J, or number)</span>
            }
<span class="nc" id="L342">        }</span>

        // Sort the values
<span class="nc bnc" id="L345" title="All 2 branches missed.">        for (int i = 0; i &lt; uniqueValues.size() - 1; i++) {</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">            for (int j = i + 1; j &lt; uniqueValues.size(); j++) {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">                if (uniqueValues.get(i) &gt; uniqueValues.get(j)) {</span>
                    // Swap values
<span class="nc" id="L349">                    int tempVal = uniqueValues.get(i);</span>
<span class="nc" id="L350">                    uniqueValues.set(i, uniqueValues.get(j));</span>
<span class="nc" id="L351">                    uniqueValues.set(j, tempVal);</span>
                    // Swap display names
<span class="nc" id="L353">                    String tempStr = displayNames.get(i);</span>
<span class="nc" id="L354">                    displayNames.set(i, displayNames.get(j));</span>
<span class="nc" id="L355">                    displayNames.set(j, tempStr);</span>
                }
            }
        }

<span class="nc" id="L360">        String[] ranks = displayNames.toArray(new String[0]);</span>
<span class="nc" id="L361">        Integer[] values = uniqueValues.toArray(new Integer[0]);</span>

<span class="nc" id="L363">        AlertDialog.Builder builder = new AlertDialog.Builder(this);</span>
<span class="nc" id="L364">        builder.setTitle(&quot;Ask &quot; + targetPlayer + &quot; for which rank?&quot;);</span>
<span class="nc" id="L365">        builder.setItems(ranks, (dialog, which) -&gt; {</span>
<span class="nc" id="L366">            int value = values[which];</span>
<span class="nc" id="L367">            sendTurn(username, targetPlayer, value);</span>
<span class="nc" id="L368">        });</span>
<span class="nc" id="L369">        builder.setNegativeButton(&quot;Cancel&quot;, null);</span>
<span class="nc" id="L370">        builder.show();</span>
<span class="nc" id="L371">    }</span>

    private int convertStringToValue(String valueStr) {
<span class="nc bnc" id="L374" title="All 5 branches missed.">        switch (valueStr) {</span>
<span class="nc" id="L375">            case &quot;A&quot;: return 14;</span>
<span class="nc" id="L376">            case &quot;K&quot;: return 13;</span>
<span class="nc" id="L377">            case &quot;Q&quot;: return 12;</span>
<span class="nc" id="L378">            case &quot;J&quot;: return 11;</span>
            default:
                try {
<span class="nc" id="L381">                    return Integer.parseInt(valueStr);</span>
<span class="nc" id="L382">                } catch (NumberFormatException e) {</span>
<span class="nc" id="L383">                    return 0;</span>
                }
        }
    }

    private void sendTurn(String askingPlayer, String targetPlayer, int value) {
        try {
<span class="nc" id="L390">            JSONObject message = new JSONObject();</span>
<span class="nc" id="L391">            message.put(&quot;type&quot;, &quot;turn&quot;);</span>
<span class="nc" id="L392">            message.put(&quot;askingPlayer&quot;, askingPlayer);</span>
<span class="nc" id="L393">            message.put(&quot;targetPlayer&quot;, targetPlayer);</span>
<span class="nc" id="L394">            message.put(&quot;value&quot;, value);</span>

<span class="nc" id="L396">            String msg = message.toString();</span>
<span class="nc" id="L397">            Log.d(TAG, &quot;Sending turn: &quot; + msg);</span>
<span class="nc" id="L398">            WebSocketManager.getInstance().sendMessage(msg);</span>

            // Clear any card selection
<span class="nc bnc" id="L401" title="All 2 branches missed.">            if (selectedCard != null) {</span>
<span class="nc" id="L402">                selectedCard.setSelected(false);</span>
<span class="nc" id="L403">                selectedCard = null;</span>
            }
<span class="nc" id="L405">        } catch (JSONException e) {</span>
<span class="nc" id="L406">            Log.e(TAG, &quot;Error creating turn message&quot;, e);</span>
<span class="nc" id="L407">            Toast.makeText(this, &quot;Error sending turn&quot;, Toast.LENGTH_SHORT).show();</span>
<span class="nc" id="L408">        }</span>
<span class="nc" id="L409">    }</span>

    // -------------------------------------------------------------------
    // JSON → GameState Parsing
    // -------------------------------------------------------------------

    private GameState parseGameState(JSONObject json) throws JSONException {
<span class="nc" id="L416">        GameState state = new GameState();</span>

        // Check if the response has a &quot;game&quot; wrapper (backend sends this sometimes)
<span class="nc" id="L419">        JSONObject gameData = json;</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">        if (json.has(&quot;game&quot;)) {</span>
<span class="nc" id="L421">            gameData = json.getJSONObject(&quot;game&quot;);</span>
        }

        // Get current turn - try multiple field names
<span class="nc bnc" id="L425" title="All 2 branches missed.">        if (json.has(&quot;currentTurn&quot;)) {</span>
<span class="nc" id="L426">            state.currentTurn = json.optString(&quot;currentTurn&quot;);</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">        } else if (gameData.has(&quot;currentPlayerUsername&quot;)) {</span>
<span class="nc" id="L428">            state.currentTurn = gameData.optString(&quot;currentPlayerUsername&quot;);</span>
        }

<span class="nc" id="L431">        Log.d(TAG, &quot;Current turn: &quot; + state.currentTurn);</span>

        // Parse players
<span class="nc" id="L434">        JSONArray playersArray = gameData.optJSONArray(&quot;players&quot;);</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">        if (playersArray != null) {</span>
<span class="nc" id="L436">            Log.d(TAG, &quot;Parsing &quot; + playersArray.length() + &quot; players&quot;);</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">            for (int i = 0; i &lt; playersArray.length(); i++) {</span>
<span class="nc" id="L438">                JSONObject p = playersArray.getJSONObject(i);</span>
<span class="nc" id="L439">                PlayerState ps = new PlayerState();</span>
<span class="nc" id="L440">                ps.username = p.optString(&quot;username&quot;);</span>

<span class="nc" id="L442">                Log.d(TAG, &quot;Parsing player: &quot; + ps.username);</span>

                // Parse hand
<span class="nc" id="L445">                JSONArray hand = p.optJSONArray(&quot;hand&quot;);</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">                if (hand != null) {</span>
<span class="nc" id="L447">                    Log.d(TAG, &quot;  Hand size: &quot; + hand.length());</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">                    for (int j = 0; j &lt; hand.length(); j++) {</span>
<span class="nc" id="L449">                        JSONObject c = hand.getJSONObject(j);</span>
<span class="nc" id="L450">                        CardState card = new CardState();</span>
<span class="nc" id="L451">                        card.value = convertValueToString(c.optInt(&quot;value&quot;));</span>
<span class="nc" id="L452">                        card.suit = c.optString(&quot;suit&quot;);</span>
<span class="nc" id="L453">                        ps.hand.add(card);</span>
                    }
                }
<span class="nc" id="L456">                ps.handSize = ps.hand.size();</span>

                // Parse completed books
<span class="nc" id="L459">                JSONArray books = p.optJSONArray(&quot;completedBooks&quot;);</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">                if (books != null) {</span>
<span class="nc" id="L461">                    ps.books = books.length();</span>
<span class="nc" id="L462">                    Log.d(TAG, &quot;  Books: &quot; + ps.books);</span>
                }

<span class="nc" id="L465">                state.players.add(ps);</span>
            }
        }

<span class="nc" id="L469">        Log.d(TAG, &quot;Finished parsing. Total players: &quot; + state.players.size());</span>

<span class="nc" id="L471">        return state;</span>
    }

    private String convertValueToString(int value) {
<span class="nc bnc" id="L475" title="All 5 branches missed.">        switch (value) {</span>
<span class="nc" id="L476">            case 14: return &quot;A&quot;;</span>
<span class="nc" id="L477">            case 13: return &quot;K&quot;;</span>
<span class="nc" id="L478">            case 12: return &quot;Q&quot;;</span>
<span class="nc" id="L479">            case 11: return &quot;J&quot;;</span>
<span class="nc" id="L480">            default: return String.valueOf(value);</span>
        }
    }

    // -------------------------------------------------------------------
    // UI Update Methods
    // -------------------------------------------------------------------

    private void updateUIFromState() {
<span class="nc" id="L489">        updatePlayerList();</span>
<span class="nc" id="L490">        updateCardsUI();</span>
<span class="nc" id="L491">        updateAskButton();</span>
<span class="nc" id="L492">    }</span>

    private void updatePlayerList() {
<span class="nc" id="L495">        playerListLayout.removeAllViews();</span>

<span class="nc bnc" id="L497" title="All 2 branches missed.">        for (PlayerState player : gameState.players) {</span>
<span class="nc" id="L498">            TextView playerView = new TextView(this);</span>

<span class="nc" id="L500">            String displayText = player.username + &quot; - Books: &quot; + player.books +</span>
                    &quot; | Cards: &quot; + player.handSize;

            // Add debug info for card count issue
<span class="nc" id="L504">            Log.d(TAG, &quot;Player &quot; + player.username + &quot; has &quot; + player.handSize + &quot; cards, &quot; + player.books + &quot; books&quot;);</span>

            // Highlight current turn
<span class="nc bnc" id="L507" title="All 2 branches missed.">            if (player.username.equals(gameState.currentTurn)) {</span>
<span class="nc" id="L508">                displayText = &quot;▶ &quot; + displayText;</span>
<span class="nc" id="L509">                playerView.setTextColor(0xFFFFFF00); // Yellow</span>
            } else {
<span class="nc" id="L511">                playerView.setTextColor(0xFFFFFFFF); // White</span>
            }

            // Highlight current user
<span class="nc bnc" id="L515" title="All 2 branches missed.">            if (player.username.equals(username)) {</span>
<span class="nc" id="L516">                playerView.setTextSize(16);</span>
<span class="nc" id="L517">                playerView.setTypeface(null, android.graphics.Typeface.BOLD);</span>
            } else {
<span class="nc" id="L519">                playerView.setTextSize(14);</span>
            }

<span class="nc" id="L522">            playerView.setText(displayText);</span>
<span class="nc" id="L523">            playerView.setPadding(16, 8, 16, 8);</span>
<span class="nc" id="L524">            playerListLayout.addView(playerView);</span>
<span class="nc" id="L525">        }</span>
<span class="nc" id="L526">    }</span>

    private void updateCardsUI() {
<span class="nc" id="L529">        Log.d(TAG, &quot;updateCardsUI called&quot;);</span>

        // Clear existing cards
<span class="nc bnc" id="L532" title="All 2 branches missed.">        for (CardView card : cards) {</span>
<span class="nc" id="L533">            rootLayout.removeView(card);</span>
<span class="nc" id="L534">        }</span>
<span class="nc" id="L535">        cards.clear();</span>

        // Find current player's hand
<span class="nc" id="L538">        PlayerState currentPlayer = null;</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">        for (PlayerState p : gameState.players) {</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">            if (p.username.equals(username)) {</span>
<span class="nc" id="L541">                currentPlayer = p;</span>
<span class="nc" id="L542">                Log.d(TAG, &quot;Found current player: &quot; + username + &quot; with &quot; + p.hand.size() + &quot; cards&quot;);</span>
<span class="nc" id="L543">                break;</span>
            }
<span class="nc" id="L545">        }</span>

<span class="nc bnc" id="L547" title="All 2 branches missed.">        if (currentPlayer == null) {</span>
<span class="nc" id="L548">            Log.w(TAG, &quot;Current player not found in game state!&quot;);</span>
<span class="nc" id="L549">            return;</span>
        }

<span class="nc bnc" id="L552" title="All 2 branches missed.">        if (currentPlayer.hand.isEmpty()) {</span>
<span class="nc" id="L553">            Log.w(TAG, &quot;Current player has no cards!&quot;);</span>
<span class="nc" id="L554">            return;</span>
        }

        // Create card views from hand data
<span class="nc bnc" id="L558" title="All 2 branches missed.">        for (CardState cardData : currentPlayer.hand) {</span>
<span class="nc" id="L559">            Log.d(TAG, &quot;Creating card: &quot; + cardData.value + cardData.suit);</span>
<span class="nc" id="L560">            CardView card = createCardFromData(cardData.value, cardData.suit);</span>
<span class="nc" id="L561">            rootLayout.addView(card);</span>
<span class="nc" id="L562">            cards.add(card);</span>
<span class="nc" id="L563">        }</span>

<span class="nc" id="L565">        Log.d(TAG, &quot;Added &quot; + cards.size() + &quot; cards to layout&quot;);</span>

        // Layout cards in arc
<span class="nc" id="L568">        setupCardLayout();</span>
<span class="nc" id="L569">        animateCardsIntroduction();</span>
<span class="nc" id="L570">    }</span>

    private CardView createCardFromData(String value, String suit) {
<span class="nc" id="L573">        CardView card = new CardView(this);</span>
<span class="nc" id="L574">        card.setId(View.generateViewId());</span>
<span class="nc" id="L575">        card.setLayoutParams(new ConstraintLayout.LayoutParams(CARD_WIDTH, CARD_HEIGHT));</span>
<span class="nc" id="L576">        card.setClickable(false); // Cards don't need to be selectable anymore</span>
<span class="nc" id="L577">        card.setFocusable(false);</span>
<span class="nc" id="L578">        card.setCard(value, suit, true);</span>

<span class="nc" id="L580">        return card;</span>
    }

    private void updateAskButton() {
        // Enable ask button only if it's the player's turn
<span class="nc" id="L585">        boolean isMyTurn = username.equals(gameState.currentTurn);</span>
<span class="nc" id="L586">        askButton.setEnabled(isMyTurn);</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">        askButton.setVisibility(isMyTurn ? View.VISIBLE : View.GONE);</span>
<span class="nc" id="L588">    }</span>

    // -------------------------------------------------------------------
    // Card Layout Methods
    // -------------------------------------------------------------------

    private void setupCardLayout() {
<span class="nc" id="L595">        ConstraintSet set = new ConstraintSet();</span>
<span class="nc" id="L596">        set.clone(rootLayout);</span>
<span class="nc" id="L597">        applyArcConstraints(set, cards);</span>
<span class="nc" id="L598">        set.applyTo(rootLayout);</span>
<span class="nc" id="L599">    }</span>

    private void applyArcConstraints(ConstraintSet set, List&lt;CardView&gt; cardList) {
<span class="nc" id="L602">        int n = cardList.size();</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">        if (n == 0) return;</span>

<span class="nc" id="L605">        float startAngle = -TOTAL_SPREAD / 2f;</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">        float angleStep = (n == 1) ? 0f : TOTAL_SPREAD / (n - 1);</span>

<span class="nc bnc" id="L608" title="All 2 branches missed.">        for (int i = 0; i &lt; n; i++) {</span>
<span class="nc" id="L609">            CardView card = cardList.get(i);</span>
<span class="nc" id="L610">            int id = card.getId();</span>

<span class="nc" id="L612">            set.connect(id, ConstraintSet.LEFT, rootLayout.getId(), ConstraintSet.LEFT, 0);</span>
<span class="nc" id="L613">            set.connect(id, ConstraintSet.RIGHT, rootLayout.getId(), ConstraintSet.RIGHT, 0);</span>
<span class="nc" id="L614">            set.connect(id, ConstraintSet.TOP, rootLayout.getId(), ConstraintSet.TOP, 0);</span>
<span class="nc" id="L615">            set.connect(id, ConstraintSet.BOTTOM, rootLayout.getId(), ConstraintSet.BOTTOM, 0);</span>

<span class="nc" id="L617">            float angle = startAngle + i * angleStep;</span>
<span class="nc" id="L618">            double rad = Math.toRadians(angle);</span>
<span class="nc" id="L619">            float xBias = (float) (CENTER_X_BIAS + RADIUS_BIAS * Math.sin(rad));</span>
<span class="nc" id="L620">            float yBias = (float) (CENTER_Y_BIAS + RADIUS_BIAS * (1 - Math.cos(rad)));</span>

<span class="nc" id="L622">            xBias = Math.max(0f, Math.min(1f, xBias));</span>
<span class="nc" id="L623">            yBias = Math.max(0f, Math.min(1f, yBias));</span>

<span class="nc" id="L625">            set.setHorizontalBias(id, xBias);</span>
<span class="nc" id="L626">            set.setVerticalBias(id, yBias);</span>
        }
<span class="nc" id="L628">    }</span>

    private void animateCardsIntroduction() {
<span class="nc" id="L631">        int n = cards.size();</span>
<span class="nc" id="L632">        float startAngle = -TOTAL_SPREAD / 2f;</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">        float angleStep = (n == 1) ? 0f : TOTAL_SPREAD / (n - 1);</span>

<span class="nc bnc" id="L635" title="All 2 branches missed.">        for (int i = 0; i &lt; n; i++) {</span>
<span class="nc" id="L636">            final CardView card = cards.get(i);</span>
<span class="nc" id="L637">            final float targetAngle = startAngle + i * angleStep;</span>
<span class="nc" id="L638">            final int index = i;</span>

<span class="nc" id="L640">            card.post(() -&gt; {</span>
<span class="nc" id="L641">                card.setPivotX(card.getWidth() / 2f);</span>
<span class="nc" id="L642">                card.setPivotY(card.getHeight());</span>
<span class="nc" id="L643">                card.setRotation(0f);</span>

<span class="nc" id="L645">                card.animate()</span>
<span class="nc" id="L646">                        .rotation(targetAngle)</span>
<span class="nc" id="L647">                        .setStartDelay(index * 80L)</span>
<span class="nc" id="L648">                        .setDuration(350)</span>
<span class="nc" id="L649">                        .start();</span>
<span class="nc" id="L650">            });</span>
        }
<span class="nc" id="L652">    }</span>

    // -------------------------------------------------------------------
    // Data Models
    // -------------------------------------------------------------------

<span class="fc" id="L658">    private static class GameState {</span>
        String currentTurn;
<span class="fc" id="L660">        List&lt;PlayerState&gt; players = new ArrayList&lt;&gt;();</span>
    }

<span class="nc" id="L663">    private static class PlayerState {</span>
        String username;
        int handSize;
        int books;
<span class="nc" id="L667">        List&lt;CardState&gt; hand = new ArrayList&lt;&gt;();</span>
    }

    private static class CardState {
        String value;
        String suit;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span>Generated by the Android Gradle plugin 8.13.0</div></body></html>